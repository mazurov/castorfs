# -*- rpm-spec -*-i
Summary:        ${RPMNAME}
Name:           ${RPMNAME}
Version:        ${PACKAGE_VERSION}
Release:        ${CPACK_PACKAGE_RELEASE}
License:        GPLv3
Group:          utils
Source:         ${CPACK_SOURCE_PACKAGE_FILE_NAME}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root
BuildRequires:	cmake
BuildRequires: fuse-devel >= 2.6
BuildRequires: castor-devel >= 2.1.6
Packager: Alexander MAZUROV <alexander.mazurov@cern.ch>

%define prefix /opt/${RPMNAME}-%{version}
%define rpmprefix $RPM_BUILD_ROOT%{prefix}
%define srcdirname %{name}-%{version}-Source

%description -n ${RPMNAME}
${RPMNAME} : filysystem client based on CASTOR

%prep
%setup -q -n %{srcdirname}

%build
cd ..
rm -rf build_tree
mkdir build_tree
cd build_tree
cmake -DCMAKE_INSTALL_PREFIX=%{rpmprefix} ../%{srcdirname}
make
  
%install 
cd ../build_tree
make install

%clean
rm -rf %{srcdirname}
rm -rf build_tree

%package -n castorfs-client
Summary: Filesystem client based on CASTOR
Group: utils
Requires: fuse >= 2.6
Requires: fuse-libs >= 2.6
Requires: castor-lib >= 2.1.6
%description -n castorfs-client
Filesystem client based on CASTOR
%files -n castorfs-client
%defattr(-,root,root,-)
%{prefix}/bin/castorfs
%{prefix}/share/man/man1/castorfs.1.gz

%post -n castorfs-client
ln -s %{prefix} /opt/${RPMNAME}

%postun -n castorfs-client
unlink /opt/${RPMNAME}
rm -rf /opt/${RPMNAME}-%{version}


%package -n castorfs-init
Summary: LHCb init scripts for filesystem client based on CASTOR
Group: utils
Requires: castorfs-client
%description -n castorfs-init
LHCb init scripts for filesystem client based on CASTOR
%files -n castorfs-init
%defattr(-,root,root,-)
%attr(755,-,-) %{prefix}/etc/init.d/castorfs-mount-r

%post -n castorfs-init
ln -s /opt/${RPMNAME}/etc/init.d/castorfs-mount-r %{_sysconfdir}/init.d/castorfs-mount-r
usermod -a -G fuse root
chkconfig --add castorfs-mount-r

%preun -n castorfs-init
chkconfig --del castorfs-mount-r

%postun -n castorfs-init
unlink %{_sysconfdir}/init.d/castorfs-mount-r

%changelog
* Wed Feb 22 2009  Alexander MAZUROV <alexander.mazurov@cern.ch>
  Generated by CMake

